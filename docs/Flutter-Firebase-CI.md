# Building Flutter Apps with Firebase in CI

The configuration generated by `flutterfire_cli` contains some settings that should not be published, although they are somewhat protected by the way that firebase works.

For an app to work with the firebase APIs there needs to be an authentication token present during the build.  On your local machine, this is  provided by you logging in to firebase using the firebase CLI.  On a remote build on GitHub, we need a different way.

The new official way to do this is to use [application default credentials](https://firebase.google.com/docs/cli#cli-ci-systems-adc) which is the Google Cloud way of doing authentication.  However, for simplicity I'll show you the [legacy method](https://firebase.google.com/docs/cli#cli-ci-systems-firebase-token) which uses a token generated by the firebase cli tool.

Assuming you have the firebase tools installed, on your local machine run:

```bash
firebase login:ci
```

This should give you a token, something like `1//0gHoUemkuYWA...` We will use this for the setting `FIREBASE_TOKEN` in our workflow.

Other settings that we need are:

- `FIREBASE_PROJECT_ID` - the name of your project, in my case comp3120-quiz, get this from the Firebase dashboard page

These three settings are enough to regenerate the Firebase configuration for your project. This means that you can now delete the following files from your GitHub repo:

- `android/app/google-services.json`
- `ios/Runner/GoogleService-Info.plist`
- `lib/firebase_options.dart`
- `firebase.json`

Remove the files and add the following lines to your [`.gitignore`](../.gitignore) file so that they are not added again in future:

```bash
# Firebase configuration files
**/google-services.json
**/GoogleService-Info.plist
lib/firebase_options.dart
firebase.json
```

**Note** even if you delete these, they will still be in the Git history in your repository, so you
would ideally invalidate the settings by eg. making a new project for your app and using that instead.

We now want to set up a GitHub action workflow that will build the APK for our app.  You can see an example that works in [this repository](../.github/workflows/build.yaml) app.

To make the workflow work, we need to set the three configuration settings above in the GitHub project.  To do that, go to Settings in your project and find "Secrets and Variables" in the menu on the left, choose "Actions" from the submenu.   Now you can create new repository secrets with the values for `FIREBASE_TOKEN` and `FIREBASE_PROJECT_ID`  mentioned above.  

These values are used by the workflow to run the following command:

```bash
flutterfire configure --project=$FIREBASE_PROJECT_ID --token=$FIREBASE_TOKEN --platforms=android --yes
```

This will create the config files we deleted above (at least the android versions). You can run this on your local machine to recreate those files as well.

The workflow should run and if it works will generate the APK file for your app.  You should be able to download the APK by viewing the successful workflow page on GitHub (click on Actions, then click on the 
build workflow, the APK download should be at the bottom of that page).

**Note** If your Flutter project is in a sub-directory of your main repository then you need to
modify the workflow to set a working directory.  See the comment near the top of the
workflow file.  Uncomment the `working-directory: ` line and enter your flutter project
directory name.   If the workflow fails, check that the spelling is correct, including upper/lower case.

